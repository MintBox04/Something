name: Run BMS Scraper

on:
  workflow_dispatch:
  schedule:
    - cron: '30 * * * *' # Run at every hour 0 minutes

jobs:
  run-shard:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.1'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright cloudscraper aiohttp pytz 
          playwright install chromium
          # Install any other deps if needed (e.g. requests, though not used in current script)

      - name: Run Shard ${{ matrix.shard }}
        shell: bash
        run: |
          if [ "${{ matrix.shard }}" == "10" ]; then
            python district_scraper.py
          else
            xvfb-run python run_bms.py ${{ matrix.shard }}
          fi

      - name: Commit and Push Shard Data
        if: success()
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Pull latest changes to avoid conflicts if possible
          git pull --rebase || echo "Rebase failed, will retry in loop"
          
          # Add output directory
          git add advance/data/
          
          # Commit
          git commit -m "[skip ci] Auto-commit: Scraped data for Shard ${{ matrix.shard }}" || echo "No changes to commit"
          
          # Push loop with rebase (handle race conditions)
          MAX_RETRIES=10
          count=0
          success=false
          
          while [ $count -lt $MAX_RETRIES ]; do
            git pull --rebase
            if git push; then
              success=true
              break
            else
              echo "Push failed, retrying ($((count+1))/$MAX_RETRIES)..."
              sleep $(( ( RANDOM % 10 )  + 1 ))
              count=$((count+1))
            fi
          done
          
          if [ "$success" = false ]; then
            echo "Failed to push after $MAX_RETRIES attempts."
            exit 1
          fi

  merge-and-commit:
    needs: run-shard
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.1'

      - name: Install Merge Dependencies
        run: |
          pip install pytz

      - name: Pull All Shard Data
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git pull --rebase

      - name: Organize Data and Combine
        run: |
          # Debug file structure (optional, good for verifying)
          ls -R advance/data
          
          # Run combination script
          python combine_shards.py

      - name: Commit and Push Summary
        run: |
          git add advance/data/
          git commit -m "Auto-commit: Combined Data" || echo "No changes to commit"
          git push


